<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ë³¸ì–´ ëŸ¬ë‹ í€´ì¦ˆ ê²Œì„ (CSV)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> 
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #game-container {
            width: 800px;
            height: 500px;
            border: 5px solid #333;
            background-color: #a8d0e6;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        #ui-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            z-index: 10;
        }
        #hearts {
            color: red;
        }
        #runner {
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 40px;
            height: 40px;
            background-color: #4CAF50; 
            border-radius: 5px;
            transition: transform 0.1s;
            z-index: 5;
        }
        #ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 50px;
            background-color: #795548;
            z-index: 4;
        }
        #question-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: none; 
            z-index: 20;
        }
        #japanese-word {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #00796b;
            font-weight: bold;
        }
        #options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .option-button {
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            border: 2px solid #333;
            background-color: #ffe082;
            transition: background-color 0.2s;
        }
        .option-button:hover {
            background-color: #ffd54f;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            color: #d32f2f;
            font-weight: bold;
            display: none;
            z-index: 30;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 40;
        }
        #start-button {
            padding: 15px 30px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #00bcd4;
            border: none;
            color: white;
            border-radius: 5px;
            margin-top: 20px;
            opacity: 0.5; /* íŒŒì¼ ì—…ë¡œë“œ ì „ì—ëŠ” íë¦¬ê²Œ */
            pointer-events: none; /* íŒŒì¼ ì—…ë¡œë“œ ì „ì—ëŠ” í´ë¦­ ë¶ˆê°€ */
        }
        #file-upload-section {
            padding: 15px;
            border: 2px dashed #ccc;
            margin-bottom: 20px;
            text-align: center;
        }
        .correct {
            background-color: #81c784 !important;
        }
        .incorrect {
            background-color: #e57373 !important;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen">
        <h1>ì¼ë³¸ì–´ ë‹¨ì–´ ëŸ¬ë‹ í€´ì¦ˆ</h1>
        <p>ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € CSV ë‹¨ì–´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
        
        <div id="file-upload-section">
            <input type="file" id="csv-file-input" accept=".csv" required>
            <p id="word-count-info">ì—…ë¡œë“œëœ ë‹¨ì–´ ìˆ˜: 0</p>
        </div>

        <button id="start-button">ê²Œì„ ì‹œì‘ (ì´ 5ê°œì˜ ëª©ìˆ¨)</button>
    </div>

    <div id="ui-bar">
        <span>SCORE: <span id="score">0</span></span>
        <span>HEARTS: <span id="hearts">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</span></span>
        <span>CHAPTER WORDS: <span id="remaining-words">0</span></span>
    </div>

    <div id="ground"></div>
    <div id="runner"></div>
    
    <div id="question-area">
        <div id="japanese-word"></div>
        <div id="options-container">
            </div>
    </div>

    <div id="message"></div>
</div>

<script>
    const GAME_SPEED = 2;
    const MAX_HEARTS = 5;
    const TIME_TO_NEXT_QUESTION = 300; // ë¬¸ì œ ê°„ê²© (í”„ë ˆì„)
    const QUIZ_PAUSE_TIME = 1500; // ì •ë‹µ/ì˜¤ë‹µ í›„ ëŒ€ê¸° ì‹œê°„ (ms)
    const CHAPTER_CLEAR_COUNT = 70; // ì±•í„° í´ë¦¬ì–´ ë‹¨ì–´ ìˆ˜ (ìš”ì²­ì‚¬í•­ ë°˜ì˜)

    let score = 0;
    let hearts = MAX_HEARTS;
    let gameLoop;
    let frameCount = 0;
    let isQuizActive = false;
    let currentCorrectAnswer = '';

    let wordData = []; // CSV íŒŒì¼ì—ì„œ íŒŒì‹±ëœ ì „ì²´ ë‹¨ì–´ ëª©ë¡
    let currentChapterWords = []; // í˜„ì¬ ì±•í„°ì—ì„œ ì•„ì§ í’€ì§€ ì•Šì€ ë‹¨ì–´ ëª©ë¡

    const gameContainer = document.getElementById('game-container');
    const runner = document.getElementById('runner');
    const scoreDisplay = document.getElementById('score');
    const heartsDisplay = document.getElementById('hearts');
    const remainingWordsDisplay = document.getElementById('remaining-words');
    const questionArea = document.getElementById('question-area');
    const japaneseWordDisplay = document.getElementById('japanese-word');
    const optionsContainer = document.getElementById('options-container');
    const messageDisplay = document.getElementById('message');
    const startScreen = document.getElementById('start-screen');
    const startButton = document.getElementById('start-button');
    const csvFileInput = document.getElementById('csv-file-input');
    const wordCountInfo = document.getElementById('word-count-info');

    // --- CSV íŒŒì¼ ì²˜ë¦¬ ---

    csvFileInput.addEventListener('change', handleFileUpload);

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            complete: function(results) {
                // ë°ì´í„° ì •ì œ ë° wordDataì— ì €ì¥
                wordData = results.data
                    .map(row => {
                        // ì²« ë²ˆì§¸ ì—´: ì¼ë³¸ì–´, ë‘ ë²ˆì§¸ ì—´: í•œêµ­ì–´ (ë¹„ì–´ìˆì§€ ì•Šì€ ìœ íš¨í•œ í–‰ë§Œ)
                        if (row.length >= 2 && row[0].trim() && row[1].trim()) {
                            return { jp: row[0].trim(), kr: row[1].trim() };
                        }
                        return null;
                    })
                    .filter(item => item !== null);

                if (wordData.length < 4) {
                    alert("âš ï¸ ë‹¨ì–´ íŒŒì¼ì˜ ë‹¨ì–´ê°€ ìµœì†Œ 4ìŒ ì´ìƒì´ì–´ì•¼ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    startButton.style.opacity = 0.5;
                    startButton.style.pointerEvents = 'none';
                    wordCountInfo.textContent = `ì—…ë¡œë“œëœ ë‹¨ì–´ ìˆ˜: ${wordData.length} (ë¶€ì¡±)`;
                    return;
                }

                wordCountInfo.textContent = `âœ… ì—…ë¡œë“œëœ ë‹¨ì–´ ìˆ˜: ${wordData.length} ê°œ`;
                startButton.style.opacity = 1.0;
                startButton.style.pointerEvents = 'auto'; // íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ ì‹œ ë²„íŠ¼ í™œì„±í™”
            },
            error: function(error) {
                alert("CSV íŒŒì¼ì„ íŒŒì‹±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        });
    }

    // --- ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘ ---
    
    startButton.addEventListener('click', startGame);

    function startGame() {
        if (wordData.length === 0) {
            alert("CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
            return;
        }

        startScreen.style.display = 'none';
        score = 0;
        hearts = MAX_HEARTS;
        frameCount = 0;
        isQuizActive = false;
        
        // CSV ë‹¨ì–´ë¥¼ í˜„ì¬ ì±•í„° ë‹¨ì–´ ëª©ë¡ìœ¼ë¡œ ì„¤ì •
        currentChapterWords = [...wordData]; 
        
        updateUI();
        gameLoop = requestAnimationFrame(gameUpdate);
    }

    // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
    
    function updateUI() {
        scoreDisplay.textContent = score;
        heartsDisplay.textContent = 'â¤ï¸'.repeat(hearts) + 'ğŸ¤'.repeat(MAX_HEARTS - hearts);
        remainingWordsDisplay.textContent = currentChapterWords.length;
    }

    // --- ê²Œì„ ë£¨í”„ ---
    
    function gameUpdate() {
        if (hearts <= 0) {
            endGame();
            return;
        }

        if (!isQuizActive) {
            // ëŸ¬ë‹ ì• ë‹ˆë©”ì´ì…˜
            frameCount++;
            runner.style.transform = `translateY(${frameCount % 20 < 10 ? 0 : -5}px)`; 

            // ë¬¸ì œ ì¶œì œ íƒ€ì´ë° ì²´í¬
            if (frameCount % TIME_TO_NEXT_QUESTION === 0 && currentChapterWords.length > 0) {
                isQuizActive = true;
                showQuestion();
            }

            // ì±•í„° í´ë¦¬ì–´ ì²´í¬ (70ê°œ ë‹¨ì–´ë¥¼ ëª¨ë‘ ë§íˆëŠ” ì¡°ê±´)
            if (wordData.length >= CHAPTER_CLEAR_COUNT && currentChapterWords.length === wordData.length - CHAPTER_CLEAR_COUNT) {
                 showMessage("âœ¨ ì±•í„° í´ë¦¬ì–´! 70ê°œ ë‹¨ì–´ ë‹¬ì„±! âœ¨", "#ffeb3b");
                 endGame(true);
                 return;
            } else if (wordData.length < CHAPTER_CLEAR_COUNT && currentChapterWords.length === 0) {
                // ë‹¨ì–´ ìˆ˜ê°€ 70ê°œ ë¯¸ë§Œì¼ ê²½ìš°, ëª¨ë‘ í’€ë©´ í´ë¦¬ì–´ ì²˜ë¦¬
                showMessage("âœ¨ ëª¨ë“  ë‹¨ì–´ í´ë¦¬ì–´! âœ¨", "#ffeb3b");
                 endGame(true);
                 return;
            }
        }
        
        gameLoop = requestAnimationFrame(gameUpdate);
    }

    // --- í€´ì¦ˆ ê´€ë ¨ í•¨ìˆ˜ ---

    function showQuestion() {
        // 1. ë¬¸ì œ ë‹¨ì–´ ì„ íƒ
        const wordIndex = Math.floor(Math.random() * currentChapterWords.length);
        const questionWord = currentChapterWords[wordIndex];
        currentCorrectAnswer = questionWord.kr;

        // 2. ì˜¤ë‹µ ë³´ê¸° 3ê°œ ì„ íƒ (ì „ì²´ wordDataì—ì„œ ê°€ì ¸ì˜´)
        const allPossibleAnswers = wordData.map(w => w.kr).filter(kr => kr !== currentCorrectAnswer);
        
        const wrongAnswers = [];
        // ë‹¨ì–´ ìˆ˜ê°€ 4ê°œ ë¯¸ë§Œì¸ ê²½ìš° ë³´ê¸° ìˆ˜ê°€ 4ê°œë³´ë‹¤ ì ì„ ìˆ˜ ìˆìŒ
        while (wrongAnswers.length < 3 && allPossibleAnswers.length > 0) {
            const randomIndex = Math.floor(Math.random() * allPossibleAnswers.length);
            wrongAnswers.push(allPossibleAnswers.splice(randomIndex, 1)[0]);
        }

        // 3. ì •ë‹µ + ì˜¤ë‹µ í•©ì¹˜ê³  ì„ê¸°
        let options = [currentCorrectAnswer, ...wrongAnswers];
        options.sort(() => Math.random() - 0.5); 

        // 4. UIì— í‘œì‹œ
        japaneseWordDisplay.textContent = questionWord.jp;
        optionsContainer.innerHTML = ''; 
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.textContent = option;
            button.addEventListener('click', () => handleAnswer(button, option === currentCorrectAnswer, questionWord));
            optionsContainer.appendChild(button);
        });

        questionArea.style.display = 'block';
    }

    function handleAnswer(clickedButton, isCorrect, questionWord) {
        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
        Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
        
        if (isCorrect) {
            clickedButton.classList.add('correct');
            score += 10;
            
            // ë§íŒ ë‹¨ì–´ëŠ” currentChapterWordsì—ì„œ ì œê±°
            currentChapterWords = currentChapterWords.filter(w => w.jp !== questionWord.jp);

            showMessage("ì •ë‹µ! ğŸ‘", "green");
        } else {
            clickedButton.classList.add('incorrect');
            // ì •ë‹µ í‘œì‹œ
            const correctButton = Array.from(optionsContainer.children).find(btn => btn.textContent === currentCorrectAnswer);
            if (correctButton) correctButton.classList.add('correct');
            
            hearts -= 1;
            showMessage("ì˜¤ë‹µ! ğŸ˜­ ì •ë‹µì€: " + currentCorrectAnswer, "red");
        }

        updateUI();
        
        setTimeout(() => {
            questionArea.style.display = 'none';
            messageDisplay.style.display = 'none';
            isQuizActive = false;
        }, QUIZ_PAUSE_TIME);
    }

    // --- ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ ---
    
    function showMessage(text, color) {
        messageDisplay.textContent = text;
        messageDisplay.style.color = color;
        messageDisplay.style.display = 'block';
    }

    // --- ê²Œì„ ì¢…ë£Œ í•¨ìˆ˜ ---
    
    function endGame(isClear = false) {
        cancelAnimationFrame(gameLoop);
        const finalMessage = isClear ? 
            `ğŸ‰ ì±•í„° í´ë¦¬ì–´! ${wordData.length >= CHAPTER_CLEAR_COUNT ? '70ê°œ ë‹¨ì–´ ë‹¬ì„±!' : 'ëª¨ë“  ë‹¨ì–´ í•™ìŠµ ì™„ë£Œ!'} ìµœì¢… ì ìˆ˜: ${score}ì ` :
            `ê²Œì„ ì˜¤ë²„! ğŸ˜¢ (ëª©ìˆ¨ ì†Œì§„) ìµœì¢… ì ìˆ˜: ${score}ì `;

        alert(finalMessage);
        
        startScreen.innerHTML = `
            <h1>${isClear ? 'CHAPTER CLEAR!' : 'GAME OVER!'}</h1>
            <h2>${finalMessage}</h2>
            <p>ìƒˆë¡œìš´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”.</p>
            <div id="file-upload-section">
                <input type="file" id="restart-csv-file-input" accept=".csv" required>
                <p id="restart-word-count-info">ì—…ë¡œë“œëœ ë‹¨ì–´ ìˆ˜: ${wordData.length} ê°œ</p>
            </div>
            <button id="restart-button" style="padding: 15px; font-size: 1.2em; background-color: #ff9800; border: none; color: white; border-radius: 5px; cursor: pointer; margin-top: 10px;">ë‹¤ì‹œ ì‹œì‘</button>
        `;

        // ì¬ì‹œì‘ í™”ë©´ì—ì„œ íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸ ì¬ì—°ê²°
        document.getElementById('restart-csv-file-input').addEventListener('change', (event) => {
             // ê¸°ì¡´ì˜ wordDataë¥¼ ë®ì–´ì“°ë„ë¡ handleFileUpload ë¡œì§ì„ ì¬ì‚¬ìš©
             handleFileUpload({ target: { files: event.target.files } });
             document.getElementById('restart-word-count-info').textContent = `âœ… ì—…ë¡œë“œëœ ë‹¨ì–´ ìˆ˜: ${wordData.length} ê°œ`;

             const restartButton = document.getElementById('restart-button');
             if (wordData.length >= 4) {
                restartButton.style.opacity = 1.0;
                restartButton.style.pointerEvents = 'auto';
             }
        });
        
        document.getElementById('restart-button').addEventListener('click', startGame);
        startScreen.style.display = 'flex';
        runner.style.transform = 'none';
    }

</script>
</body>
</html>